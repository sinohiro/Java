<!--?xml version="1.0" encoding="utf-8"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>プログラミング言語IIIB(Java) テーマ18</title>
<link rel="stylesheet" href="%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E8%A8%80%E8%AA%9EIIIB(Java)%20%E3%83%86%E3%83%BC%E3%83%9E18_files/tenmo2008single.css" type="text/css" media="all">
</head>

<body>

<h2>プログラミング言語IIIB(Java) テーマ18</h2>

<h3><code>Timer</code>クラス</h3>

<p><code>Timer</code>クラスを用いると, 一定時間毎に<em>自動的に</em>アクションイベントが発生し, <code>actionPerformed</code>メソッドが呼び出される. この機能を利用して, 一定時間毎に<em>少しずつ異なる絵や画像</em>を, <em>少しずつ異なる位置</em>に描画する事で, アニメーションが実現できる.</p>

<p><code>Timer</code>クラスを利用する方法は以下の通りである. 今回は, タイマーを<em>フレーム</em>に設置し, タイマーで定期的に呼び出される<code>actionPerformed</code>メソッドから, さらに<em>描画パネル</em>に対して<code>repaint</code>をかける方式で行う.</p>

<ol>

<li><em>フレーム</em>の<em>フィールド</em>に, <code>Timer</code>クラスのオブジェクト変数を追加する.</li>
<pre>// -------- MyFrame側フィールド --------
private Timer timer;
</pre>

<li><em>フレーム</em>の<em>コンストラクタ</em>で, <code>Timer</code>クラスのインスタンスを生成する. 引数は<em>呼び出し間隔</em>(単位ミリ秒)と, 呼び出される<code>actionPerformed</code>メソッドを持つインスタンスである(つまり<code>this</code>). その後, タイマーをスタートさせる.</li>
<pre>// -------- MyFrame側コンストラクタ --------
this.timer = new Timer(500, this); // 0.5秒ごとにthisのactionPerformedメソッドが呼び出される. 
this.timer.start();                // タイマースタート
</pre>

<li><em>フレーム</em>の<code class="em">actionPerformed</code>メソッドに, 一定時間毎に行いたい処理を書く. (今回は描画パネルの<code>repaint</code>)</li>
<pre>// -------- MyFrame側メソッド --------
public void actionPerformed(ActionEvent e)
{
    this.mp.repaint(); // 描画パネル「に対して」再描画させる
}
</pre>
<li><em>描画パネル</em>の<code>paintComponent</code>で, グラフィックスを描く.</li>
<pre>// -------- MyPanel側メソッド --------
public void paintComponent(Graphics g)
{
    // 少しずつ異なる絵や画像を, 少しずつ異なる位置に描画する. 例えば
    x座標やy座標を更新;
    モーション番号iを更新;
    (x,y)にキャラクター画像のi番目を描画;
}
</pre>

</ol>

<p><!--各クラスやメソッドの関係は以下のUML図の様になる. -->一つのクラスに全ての機能を詰め込むのではなく, クラス毎に<em>役割を分担</em>している点に注目せよ. (→最終テーマ20では三つのクラスに分割する.)</p>
<!--
<center>
<img src="timer_anime.png" border="1">
</center>
-->

<p><code>Timer</code>クラスにはこの他にも様々なメソッドがある. 自分のアイデアに応じて適宜調査して利用し, 報告してみて欲しい.</p>

<h3>画像ファイルの読込みと描画</h3>

<p>パネルに描く画像は以下の手順で用意する. <em>どこ</em>(場所)に, <em>何</em>を記述するのか, 良く注意すること.</p>

<ol>

<li><em>フレーム</em>の<em>コンストラクタ</em>で画像ファイルを読み込む. 画像ファイルはプログラムと同じディレクトリに置いておく.</li>
<pre>// -------- MyFrame側コンストラクタ --------
Toolkit tk = Toolkit.getDefaultToolkit(); // 画像ファイル読み込み機能等が入った道具箱
Image chara = tk.getImage("chara.png"); // chara.pngを読み込み, 変数charaに代入する. 
</pre>

<li><em>フレーム</em>の<em>コンストラクタ</em>で, 描画パネルのインスタンスを生成する時に, 手順1で用意した画像インスタンスを<em>引数</em>として渡す.</li>
<pre>// -------- MyFrame側コンストラクタ --------
this.mp = new MyPanel(chara); // 引数に注目
</pre>

<li><em>描画パネル</em>の<em>コンストラクタ</em>で, 引数で受け取った画像を<em>フィールド</em>に保存しておく.</li>
<pre>// -------- MyPanel側フィールド --------
private Image chara;

// -------- MyPanel側コンストラクタ --------
public MyPanel(Image chara) // 引数で受け取り
{
    this.chara = chara;     // フィールドに保存する. 
}
</pre>
<p>※コンストラクタの引数ではなく, セッターで渡す方式でも良い.</p>

<li><em>描画パネル</em>の<code class="em">paintComponent</code>メソッドで, 画像を描画する.</li>
<pre>// -------- MyPanel側メソッド --------
public void paintComponent(Graphics g)
{
    super.paintComponent(g);
    g.drawImage(this.chara, x, y, this); // x, y は自分で設定, 最後の引数はthis
}
</pre>

</ol>

<p>なお, Javaで画像ファイルを読み込む方法にはこの他にも様々なバリエーションが存在するが, 次回テーマの<em>アプレット化</em>を容易にするために, 今回の課題では<u>上記のルールに従って</u>プログラミングして欲しい. (従わないと次回, 大変苦労する. )</p>

<p>※大切な事なのでもう一度: 従っておかないと, 次回以降, 大変苦労する.</p>

<h3>画像の配列</h3>

<p>アニメーションを行うためには少しずつ異なる<em>複数の画像</em>が必要となる(パラパラマンガを想像せよ). それら複数の画像をひとまとめに扱うには, <em>配列</em>が便利である.</p>

<p>以下に, 10枚の画像から成る配列の生成方法の例を示す. 前節の例では単一の画像データ(<code>chara</code>)をフレームから描画パネルへ渡していたが, この場合は画像の配列(<code>chara_array</code>)を渡している.</p>

<pre>// -------- MyFrame側コンストラクタ --------
Image[] chara_array = new Image[10]; // Imageクラスの配列
for (int i = 0; i &lt; 10; i++)
{
    chara_array[i] = tk.getImage("chara" + i + ".png"); // chara0.png, ..., chara9.png
}
this.mp = new MyPanel(chara_array); // 配列を渡す. 受け取る方も当然, 修正が必要. 
</pre>

<p>※大切な事なのでもう一度: <u>受け取る方も修正が必要</u>.</p>

<p>※配列と<code>for</code>文が苦手な人は, <a href="http://jsuri1.info.kushiro-ct.ac.jp/~tenmo/java/10/">テーマ10</a>などを再確認して十分に復習しておく.</p>

<h3>アニメーション</h3>

<p><em>描画パネル</em>の<em>フィールド</em>に, 現在の<em>モーション番号</em>を表す状態変数を追加し, その<em>モーション番号に応じた</em>画像を描画する. その後, モーション番号をインクリメント(+1)しておく.</p>

<p>また, キャラクターを描く座標(x,y)もフィールドとし, (x,y)を次々と変化させることで, 動きを表すことができる. 例えばxを増加させると右に動くことになる.</p>

<!--
<p>例えば, サンプル(<a href="sample-2016/MyFrame.java">フレーム<a>, <a href="sample-2016/MyPanel.java">パネル</a>)では以下の様な多数の状態変数を用意し, <code>paintComponent</code>メソッド中でこれらの変数の値を変化させ, その値に応じて描く画像の<em>種類(番号)</em>と<em>位置</em>を決定している.</p>
<ul>
  <li>自機の位置</lI>
  <li>自機のモーションの状態(番号)</li>
  <li>自機と敵機の間の距離</li>
  <li>やられているかいないかの状態</li>
  <li>やられモーションの状態(番号)</li>
</ul>

<p>※ただし, 上記サンプルは必要以上に複雑なので, 自分で考えた方が簡単.</p>
-->

<h3>課題</h3>

<p>以下の課題のレポートは, レポートファイル<code class="em">report18.txt</code>を作成してアップロードにより提出すること.</p>

<p><em>[注意]</em> 課題4にて, 課題1〜課題3の遂行時に各自で調査した事柄(<code>Timer</code>クラスの<code>start</code>以外のメソッドや<code>MediaTracker</code>クラスの使い方等)を載せる必要があるので, 途中で調べた事柄はファイルに貼り付けたりブックマークするなど, メモを残しておくと良い.</p>

<ol>

  <li>画像ファイルを<em>一つ</em>読み込み, 適当な固定位置に, その画像を描画するプログラムを作成せよ. (ソース及び開発者向け解説(どこで何を読み込み, どこからどこへ何を渡し, どこに保存しておき, どのタイミングでどのメソッドが呼ばれ, 何を描画するなど)を報告)
    <ul>
      <li>画像ファイルは各自の好みで用意して良いが, <u>セクハラ</u>となるもの, 他人を<u>誹謗中傷</u>するもの, <u>外交・宗教</u>に関わる画像は避けること. GIMP等による<em>自作</em>を推奨. フリーの素材を利用しても良い.</li>
      <li><em>[重要]</em> 画像の大きさは100x100以下程度の小さいものを用いること.</li>
      <li>※大切な事なのでもう一度: <u>画像は小さいもの</u>を用いること.</li>
      <li><code>getImage</code>メソッドによる画像ファイルの読込みは自動的にバックグラウンドでの並列処理となるため, 読込み処理が完了しない段階で次の行に進んでしまう. このため, 画像が大きかったりネットワークに遅延があると, まだ画像の読込みが終了していない状態で描画してしまい, <em>画像が表示されない</em>という現象が発生する. この現象が疑われる場合は, 課題1・課題2の段階では, ウィンドウを切り替えるなど, <code>repaint</code>を誘発してみて欲しい.</li>
    </ul></li>

  <li>画像ファイルを<em>複数</em>読み込み, 適当な固定位置にそれらの画像を<em>全て同時</em>に描画するプログラムを作成せよ. 複数の画像は<em>配列</em>を用いてまとめて扱うこと. (課題1から変更があった部分のソース及び, 課題1から変更があった部分の開発者向け解説を報告)
    <ul>
      <li>画像ファイルを多数用意する事が目的<em>ではない</em>ので, 画像ファイルは少なくとも3枚あれば良い.</li>
    </ul></li>

  <li>課題2のプログラムを元に, <code>Timer</code>クラスを用いて画像のアニメーション表示を行うプログラムを作成せよ. (ソース, ユーザー向け解説(何がどの様に動くアニメーションか, 特に注目して欲しいセールスポイントなど), 開発者向け解説を報告)
    <ul>
      <li>画像ファイルを多数用意する事が目的<em>ではない</em>ので, 画像ファイルは少なくとも3枚あれば良い. むしろ<em>動き</em>(座標)の計算や, <em>状態</em>の変化に力を注いで欲しい.</li>
      <li>※大切な事なのでもう一度: <u>座標の変化</u>や<u>状態</u>の変化を重点的に.</li>
      <li>画像を描画する<em>位置</em>を時々刻々と変化させるのであるから, 画像の大きさは100x100以下程度に小さくすること. 巨大な画像ファイルを, 内容だけ変化させて固定位置に描画しては誤りである.</li>
      <li>※大切な事なのでもう一度: <u>画像は小さいもの</u>を用いること.</li>
      <li>アニメーションのために<code>for</code>文や<code>while</code>文等で<em>ループさせては誤り</em>である. 位置や状態を表すフィールドを活用すること.</li>
      <li>アニメーション用に大量の画像ファイルを読み込もうとすると, まだ画像が全て揃っていない状態でタイマーが開始してしまい, 画像が表示されないという現象が発生する. この問題を回避するためには<code class="em">MediaTracker</code>クラスという画像ファイルの読込み完了を待つ機能を用いる必要がある. 各自で調査して自分のプログラムに適用してみて欲しい. (基礎実験室後ろの<u>黄色い図書</u>を参考にすると瞬時に分かる)</li>
	<li>各種のGUI部品や, マウスイベント, キーイベントを併用してアニメーションの動作に介入できたり, キャラクターを操作できるようにする等, 複雑な動作に挑戦しても良い. (良いが, 締切優先とすること. 超大作を目指す必要はない. )</li>
    </ul></li>

<li>課題1,2,3の遂行時に各自で調査した事柄をまとめよ. 引用元を必ず明記し, そのまま丸写しはせずに, マニュアルとして参照し易い様に編集を加えること. <em>何も無しや, 課題ページのみ, は不可</em>.</li>

</ol>

<h3>ヘルプとアドバイス</h3>

<ul>

<li>各種GUI部品の配置や, ボタンが押された場合の処理等は, これまで通りフレームで行う. <!--フレームと描画パネルの<em>役割分担</em>に注意せよ. --></li>

<!--
<li>今回は, フレームと描画パネルの<em>両方</em>に<code>actionPerformed</code>を作成する. どのタイミングでどちらの<code>actionPerformed</code>が呼び出されるのか, 良く考えてみよ.</li>
-->

<li>今回用いる<code>Timer</code>クラスは<code class="em">javax.swing.Timer</code>である. 間違えて<code>java.util.Timer</code>を使うとエラーや挙動不審の原因となるので注意せよ.</li>

<li>タイマーで呼び出される<code>actionPerformed</code>は, 短い時間間隔で次々と呼び出されるものであるから, <code>actionPerformed</code>や<code>paintComponent</code>の中であまりに時間のかかる重い処理(計算)を行ってはならない. <em>処理落ち</em>(コマ落ち)が発生してしまう.</li>

<li>アニメーションで動かしたいキャラクター画像の背景部分を<em>透過</em>させ, 大きな背景画像と重ねるには, 画像ファイルをGIMP等で透過PNG等に変換して描画すると良い.</li>

<!--
<li>キーイベントの使用例</li>
  <ul>
  <li>どうしてもキーボード操作を行いたい場合は以下のコードを参照のこと.</li>
  <li>今回の課題で使用する必要は全く<em>無い</em>.</li>
  <li><a href="KeyTest1Frame.java">フレーム</a> / <a href="KeyTest1Panel.java">パネル</a></li>
  </ul>
-->

</ul>

<h3>レポート</h3>

<ul>
<li>内容: 課題中に指示されている通り. 必要な項目を全て記載しているか, 十分に確認すること.</li>
<p><em>注意:</em> 次回のテーマ19で, 今回作成したアニメーションをアプレット化し, <u>さらに改造</u>することも可能なので, 今回の課題で無理をする必要は全く無い. 締切までに提出することを最優先とすること.</p>
</ul>



</body></html>